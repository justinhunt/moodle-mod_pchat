define(["jquery","core/log","core/str","core/modal_factory","core/modal_events","core/fragment","core/ajax","core/yui"],function(a,b,c,d,e,f,g,h){const i=function(a,b){this.contextid=b,this.preinit(a)};return i.prototype.modal=null,i.prototype.contextid=-1,i.prototype.preinit=function(b){var f=b,g=this;c.get_string("dorubricgrade","mod_pchat").then(function(a){g.formtitle=a}),a(f).on("click",function(b){b.preventDefault(),g.studentid=a(this).attr("data-student-id"),g.cmid=a(this).attr("data-cm-id"),d.create({type:d.types.SAVE_CANCEL,title:g.formtitle,body:g.getBody()}).then(function(a){return g.modal=a,g.modal.setLarge(),g.modal.getRoot().on(e.hidden,function(){g.modal.setBody(g.getBody())}.bind(g)),g.modal.getRoot().on(e.shown,function(){g.modal.getRoot().append("<style>[data-fieldtype=submit] { display: none ! important; }</style>")}),g.modal.getRoot().on(e.save,g.submitForm.bind(g)),g.modal.getRoot().on("submit","form",g.submitFormAjax.bind(g)),g.modal.show(),g.modal})})},i.prototype.init=function(b){var f=b;return this.studentid=a(b).attr("data-student-id"),this.cmid=a(b).attr("data-cm-id"),c.get_string("creategroup","core_group").then(function(a){return d.create({type:d.types.SAVE_CANCEL,title:a,body:this.getBody()},f)}.bind(this)).then(function(a){return this.modal=a,this.modal.setLarge(),this.modal.getRoot().on(e.hidden,function(){this.modal.setBody(this.getBody())}.bind(this)),this.modal.getRoot().on(e.shown,function(){this.modal.getRoot().append("<style>[data-fieldtype=submit] { display: none ! important; }</style>")}.bind(this)),this.modal.getRoot().on(e.save,this.submitForm.bind(this)),this.modal.getRoot().on("submit","form",this.submitFormAjax.bind(this)),this.modal}.bind(this))},i.prototype.getBody=function(a){"undefined"==typeof a&&(a={});var b={jsonformdata:JSON.stringify(a)};return b.studentid=this.studentid,b.cmid=this.cmid,f.loadFragment("mod_pchat","new_grade_form",this.contextid,b)},i.prototype.handleFormSubmissionResponse=function(){this.modal.hide(),h.use("moodle-core-formchangechecker",function(){M.core_formchangechecker.reset_form_dirty_state()});var c=a(".card[data-original-student='"+this.studentid+"']"),d=g.call([{methodname:"mod_pchat_get_grade_submission",args:{userid:this.studentid,cmid:this.cmid}}]);d[0].done(function(d){b.debug("promises-done"),b.debug(d),d&&d.response[0]&&(b.debug(d.response[0]),b.debug(c),a(c).find(".chatrubricscore").html(d.response[0].rubricscore),a(c).find(".chatfeedback").html(d.response[0].feedback))}).fail(function(a){})},i.prototype.handleFormSubmissionFailure=function(b){this.modal.setBody(this.getBody(b)),a("[data-original-student]").trigger("change")},i.prototype.submitFormAjax=function(b){b.preventDefault();var c=document.createEvent("HTMLEvents");c.initEvent("change",!0,!0),this.modal.getRoot().find(":input").each(function(a,b){b.dispatchEvent(c)});var d=a.merge(this.modal.getRoot().find('[aria-invalid="true"]'),this.modal.getRoot().find(".error"));if(d.length)return void d.first().focus();var e=this.modal.getRoot().find("form").serialize();g.call([{methodname:"mod_pchat_submit_create_grade_form",args:{contextid:this.contextid,jsonformdata:JSON.stringify(e),studentid:parseInt(this.studentid)?parseInt(this.studentid):0,cmid:parseInt(this.cmid)?parseInt(this.cmid):0},done:this.handleFormSubmissionResponse.bind(this,e),fail:this.handleFormSubmissionFailure.bind(this,e)}]),this.modal.hide()},i.prototype.submitForm=function(a){a.preventDefault(),this.modal.getRoot().find("form").submit()},{init:function(a,b){return new i(a,b)}}});