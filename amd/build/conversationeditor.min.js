define(["jquery","mod_pchat/definitions","mod_pchat/conversationconstants","mod_pchat/vtthelper","mod_pchat/conversationset","mod_pchat/playerhelper","core/templates"],(function($,def,constants,vtthelper,transcriptionset,playerhelper,templates){return{controls:{},currentindex:!1,currentitemcontainer:null,editoropen:!1,firstrender:!0,init:function(transcriptiondata,mediatype){transcriptionset.init(transcriptiondata),playerhelper.init(mediatype),this.initControls(),this.initTiles(),this.initEvents()},initControls:function(){this.controls.container=$("#poodllconvedit_tiles"),this.controls.editor=$("#poodllconvedit_editor"),this.controls.number=$("#poodllconvedit_editor .numb_song"),this.controls.edpart=$("#"+def.C_EDITFIELD),this.controls.buttondelete=$("#"+def.C_BUTTONDELETE),this.controls.buttonmoveup=$("#"+def.C_BUTTONMOVEUP),this.controls.buttonmovedown=$("#"+def.C_BUTTONMOVEDOWN),this.controls.buttonapply=$("#"+def.C_BUTTONAPPLY),this.controls.buttoncancel=$("#"+def.C_BUTTONCANCEL),this.controls.buttonaddnew=$("#poodllconvedit_addnew")},hideEditor:function(){this.controls.editor.detach(),this.controls.editor.hide(),this.editoropen=!1},restoreTile:function(){var item=transcriptionset.fetchItem(this.currentindex),that=this;this.fetchNewTextTile(this.currentindex,item.part,(function(tile){that.hideEditor(),that.currentitemcontainer.append(tile)}))},editorToTile:function(controls,currentindex,currentitemcontainer,onend){var part=$(controls.edpart).val();transcriptionset.updateItem(currentindex,part),this.doSave();var that=this;return this.fetchNewTextTile(currentindex,part,(function(tile){that.editoropen&&(that.hideEditor(),currentitemcontainer.append(tile),$(currentitemcontainer).removeClass("warning"),onend&&onend())})),!0},initEvents:function(){var that=this;this.controls.container.on("click",".poodllconvedit_tt",(function(){var newindex=parseInt($(this).parent().attr("data-id")),theparent=$(this).parent(),do_next_tile_edit=function(){that.currentindex=newindex,that.currentitemcontainer=theparent,that.shiftEditor(that.currentindex,that.currentitemcontainer)};!0===that.editoropen?that.editorToTile(that.controls,that.currentindex,that.currentitemcontainer,do_next_tile_edit):do_next_tile_edit()})),this.controls.container.on("click","#"+def.C_BUTTONDELETE,(function(){result=confirm("Warning! This tile is going to be deleted!"),result&&(that.restoreTile(),transcriptionset.removeItem(that.currentindex),that.syncFrom(that.currentindex))})),this.controls.container.on("click","#"+def.C_BUTTONMOVEUP,(function(){that.editorToTile(that.controls,that.currentindex,that.currentitemcontainer,(function(){transcriptionset.moveup(that.currentindex),that.syncFrom(that.currentindex-1),that.doSave()}))})),this.controls.container.on("click","#"+def.C_BUTTONMOVEDOWN,(function(){that.editorToTile(that.controls,that.currentindex,that.currentitemcontainer,(function(){transcriptionset.movedown(that.currentindex),that.syncFrom(that.currentindex),that.doSave()}))})),this.controls.container.on("click","#"+def.C_BUTTONAPPLY,(function(){that.editorToTile(that.controls,that.currentindex,that.currentitemcontainer)})),this.controls.container.on("focusout",(function(){that.editorToTile(that.controls,that.currentindex,that.currentitemcontainer)})),this.controls.container.on("click","#"+def.C_BUTTONCANCEL,(function(){that.restoreTile()})),this.controls.buttonaddnew.click((function(){var currentcount=transcriptionset.fetchCount(),newdataid=currentcount;if(currentcount>0)transcriptionset.fetchItem(currentcount-1);transcriptionset.addItem(newdataid,"");that.fetchNewTextTileContainer(newdataid,"",(function(newtile){that.controls.container.append(newtile),$('.poodllconvedit_itemcontainer[data-id="'+newdataid+'"] .poodllconvedit_tt').trigger("click")}))}))},initTiles:function(){var container=this.controls.container,that=this,setcount=transcriptionset.fetchCount();this.fetchNewTextTile(0,"",(function(){if(setcount>0)for(var setindex=0;setindex<setcount;setindex++){var item=transcriptionset.fetchItem(setindex);that.fetchNewTextTileContainer(setindex,item.part,(function(newtile){container.append(newtile)}))}}))},shiftEditor:function(newindex,newitemcontainer){this.controls.editor.hide();var part=transcriptionset.fetchItem(newindex).part;$(this.controls.edpart).val(part),newitemcontainer.empty(),newitemcontainer.append(this.controls.editor),this.controls.editor.show(),this.editoropen=!0,$(this.controls.number).text(newindex+1)},fetchNewTextTile:function(dataid,part,onend){var tdata=[];tdata.imgpath=M.cfg.wwwroot+"/mod/pchat/pix/e/",tdata.dataid=dataid+1,tdata.part=part,templates.render("mod_pchat/convtile",tdata).then((function(html,js){onend(html)}))},fetchNewTextTileContainer:function(dataid,part,onend){var tdata=[];tdata.imgpath=M.cfg.wwwroot+"/mod/pchat/pix/e/",tdata.outerdataid=dataid,tdata.dataid=dataid+1,tdata.part=part,templates.render("mod_pchat/convtilecontainer",tdata).then((function(html,js){onend(html)}))},clearTiles:function(){this.controls.container.empty()},resetData:function(transcriptiondata){this.hideEditor(),this.clearTiles(),transcriptionset.init(transcriptiondata),this.initTiles(),this.doSave()},syncFrom:function(index){for(var setcount=transcriptionset.fetchCount(),that=this,setindex=index;setindex<setcount;setindex++){var item=transcriptionset.fetchItem(setindex),container=$(".poodllconvedit_itemcontainer").filter((function(){return parseInt($(this).attr("data-id"))==setindex}));if(container.length>0)this.updateTextTile(container,item);else this.fetchNewTextTileContainer(setindex,item.part,(function(newtile){that.controls.container.append(newtile)}))}$(".poodllconvedit_itemcontainer").filter((function(){return parseInt($(this).attr("data-id"))>=setcount})).remove()},syncAt:function(index){},updateTextTile:function(container,item){$(container).find(".poodllconvedit_tt_part").text(item.part)},fetchTranscriptionData:function(){return transcriptionset.fetchTranscriptionData()},doSave:function(){}}}));

//# sourceMappingURL=conversationeditor.min.js.map