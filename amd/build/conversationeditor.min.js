define(["jquery","mod_pchat/definitions","mod_pchat/conversationconstants","mod_pchat/vtthelper","mod_pchat/conversationset","mod_pchat/playerhelper","core/templates"],function(a,b,c,d,e,f,g){return{controls:{},currentindex:!1,currentitemcontainer:null,editoropen:!1,firstrender:!0,init:function(a,b){e.init(a),f.init(b),this.initControls(),this.initTiles(),this.initEvents()},initControls:function(){this.controls.container=a("#poodllconvedit_tiles"),this.controls.editor=a("#poodllconvedit_editor"),this.controls.number=a("#poodllconvedit_editor .numb_song"),this.controls.edpart=a("#"+b.C_EDITFIELD),this.controls.buttondelete=a("#"+b.C_BUTTONDELETE),this.controls.buttonmoveup=a("#"+b.C_BUTTONMOVEUP),this.controls.buttonmovedown=a("#"+b.C_BUTTONMOVEDOWN),this.controls.buttonapply=a("#"+b.C_BUTTONAPPLY),this.controls.buttoncancel=a("#"+b.C_BUTTONCANCEL),this.controls.buttonaddnew=a("#poodllconvedit_addnew")},hideEditor:function(){this.controls.editor.detach(),this.controls.editor.hide(),this.editoropen=!1},restoreTile:function(){var a=e.fetchItem(this.currentindex),b=this,c=function(a){b.hideEditor(),b.currentitemcontainer.append(a)};this.fetchNewTextTile(this.currentindex,a.part,c)},editorToTile:function(b,c,d,f){var g=a(b.edpart).val();e.updateItem(c,g),this.doSave();var h=this,i=function(b){h.hideEditor(),d.append(b),a(d).removeClass("warning"),f&&f()};return this.fetchNewTextTile(c,g,i),!0},initEvents:function(){var c=this;this.controls.container.on("click",".poodllconvedit_tt",function(){var b=parseInt(a(this).parent().attr("data-id")),d=a(this).parent(),e=function(){c.currentindex=b,c.currentitemcontainer=d,c.shiftEditor(c.currentindex,c.currentitemcontainer)};c.editoropen===!0?c.editorToTile(c.controls,c.currentindex,c.currentitemcontainer,e):e()}),this.controls.container.on("click","#"+b.C_BUTTONDELETE,function(){result=confirm("Warning! This tile is going to be deleted!"),result&&(c.restoreTile(),e.removeItem(c.currentindex),c.syncFrom(c.currentindex))}),this.controls.container.on("click","#"+b.C_BUTTONMOVEUP,function(){var a=function(){e.moveup(c.currentindex),c.syncFrom(c.currentindex-1),c.doSave()};c.editorToTile(c.controls,c.currentindex,c.currentitemcontainer,a)}),this.controls.container.on("click","#"+b.C_BUTTONMOVEDOWN,function(){var a=function(){e.movedown(c.currentindex),c.syncFrom(c.currentindex),c.doSave()};c.editorToTile(c.controls,c.currentindex,c.currentitemcontainer,a)}),this.controls.container.on("click","#"+b.C_BUTTONAPPLY,function(){c.editorToTile(c.controls,c.currentindex,c.currentitemcontainer)}),this.controls.container.on("click","#"+b.C_BUTTONCANCEL,function(){c.restoreTile()}),this.controls.buttonaddnew.click(function(){var b=e.fetchCount(),d=b;if(b>0){e.fetchItem(b-1)}e.addItem(d,"");var f=function(b){c.controls.container.append(b),a('.poodllconvedit_itemcontainer[data-id="'+d+'"] .poodllconvedit_tt').trigger("click")};c.fetchNewTextTileContainer(d,"",f)})},initTiles:function(){var a=this.controls.container,b=this,c=e.fetchCount(),d=function(){if(c>0)for(var d=0;d<c;d++){var f=e.fetchItem(d),g=function(b){a.append(b)};b.fetchNewTextTileContainer(d,f.part,g)}};this.fetchNewTextTile(0,"",d)},shiftEditor:function(b,c){this.controls.editor.hide();var d=e.fetchItem(b),f=d.part;a(this.controls.edpart).val(f),c.empty(),c.append(this.controls.editor),this.controls.editor.show(),this.editoropen=!0,a(this.controls.number).text(b+1)},fetchNewTextTile:function(a,b,c){var d=[];d.imgpath=M.cfg.wwwroot+"/mod/pchat/pix/e/",d.dataid=a+1,d.part=b,g.render("mod_pchat/convtile",d).then(function(a,b){c(a)})},fetchNewTextTileContainer:function(a,b,c){var d=[];d.imgpath=M.cfg.wwwroot+"/mod/pchat/pix/e/",d.outerdataid=a,d.dataid=a+1,d.part=b,g.render("mod_pchat/convtilecontainer",d).then(function(a,b){c(a)})},clearTiles:function(){this.controls.container.empty()},resetData:function(a){this.hideEditor(),this.clearTiles(),e.init(a),this.initTiles(),this.doSave()},syncFrom:function(b){for(var c=e.fetchCount(),d=this,f=b;f<c;f++){var g=e.fetchItem(f),h=a(".poodllconvedit_itemcontainer").filter(function(){return parseInt(a(this).attr("data-id"))==f});if(h.length>0)this.updateTextTile(h,g);else{var i=function(a){d.controls.container.append(a)};this.fetchNewTextTileContainer(f,g.part,i)}}a(".poodllconvedit_itemcontainer").filter(function(){return parseInt(a(this).attr("data-id"))>=c}).remove()},syncAt:function(a){},updateTextTile:function(b,c){a(b).find(".poodllconvedit_tt_part").text(c.part)},fetchTranscriptionData:function(){return e.fetchTranscriptionData()},doSave:function(){}}});