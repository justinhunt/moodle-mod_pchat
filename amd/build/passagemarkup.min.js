define(["jquery","core/log","mod_pchat/popoverhelper"],function(a,b,c){"use strict";return b.debug("Passage Markup: initialising"),{controls:{},currentmode:"grading",constants:{REVIEWMODE_NOERRORS:0,REVIEWMODE_SHOWERRORS:1},cd:{passagecontainer:"mod_pchat_grading_passagecont",summarytranscript:"mod_pchat_summarytranscript",summarytranscriptplaceholder:"mod_pchat_summarytranscriptplaceholder",audioplayerclass:"mod_pchat_passageaudioplayer",wordplayerclass:"mod_pchat_hidden_player",wordclass:"mod_pchat_grading_passageword",spaceclass:"mod_pchat_grading_passagespace",badwordclass:"mod_pchat_grading_badword",endspaceclass:"mod_pchat_grading_endspace",unreadwordclass:"mod_pchat_grading_unreadword",unreadspaceclass:"mod_pchat_grading_unreadspace",aiunmatched:"mod_pchat_aiunmatched",turnclass:"summarytranscriptpart"},options:{endwordnumber:0,errorwords:{},activityid:null,attemptid:null,sesskey:null,turns:[],reviewmode:1},init:function(c){var d="#"+c.id,e=a(d).get(0);if(!e)return void b.debug("Passage Markup js: No config found on page. Giving up.");var f=JSON.parse(e.value);a(d).remove(),this.register_controls(),this.options.activityid=f.activityid,this.options.attemptid=f.attemptid,this.options.sesskey=f.sesskey,this.options.turns=f.turns,this.options.totalwordcount=a("."+this.cd.wordclass).length,f.sessiontime>0?(""!==f.sessionerrors?this.options.errorwords=JSON.parse(f.sessionerrors):this.options.errorwords={},this.options.totalseconds=f.sessiontime,this.options.endwordnumber=f.sessionendword,this.options.sessionscore=f.sessionscore,f.sessionmatches?this.options.sessionmatches=JSON.parse(f.sessionmatches):this.options.sessionmatches=[],this.options.aidata=f.aidata,this.options.aidata?(this.options.transcriptwords=f.aidata.transcript.split(" "),this.options.transcriptwords=this.options.transcriptwords.filter(function(a){return""!==a})):this.options.transcriptwords=[],this.markup_badwords(),this.markup_aiunmatchedwords(),this.markup_aiunmatchedspaces(),this.markup_turns(),a("."+this.cd.passagecontainer).removeClass(this.cd.summarytranscriptplaceholder).addClass(this.cd.summarytranscript)):this.options.endwordnumber=this.options.totalwordcount;var g=a("#"+this.cd.spaceclass+"_"+this.options.endwordnumber);g.addClass(this.cd.endspaceclass),this.register_events(),this.init_popoverhelper()},init_popoverhelper:function(){c.init()},register_controls:function(){this.controls.wordplayer=a("#"+this.cd.wordplayerclass),this.controls.audioplayer=a("#"+this.cd.audioplayerclass),this.controls.eachword=a("."+this.cd.wordclass),this.controls.eachspace=a("."+this.cd.spaceclass),this.controls.endwordmarker=a("#"+this.cd.spaceclass+"_"+this.options.endwordnumber),this.controls.passagecontainer=a("."+this.cd.passagecontainer)},register_events:function(){var b=this;this.controls.passagecontainer.on("click","."+this.cd.wordclass,function(){var d=parseInt(a(this).attr("data-wordnumber"));if(c.isShowing(this)||b.doPlaySpotCheck(d),a(this).hasClass(b.cd.aiunmatched)){var e=b.fetchTranscriptChunk(d);e&&c.addTranscript(this,e)}})},doPlaySpotCheck:function(c){var d=this.fetchWordPlayChain(c);b.debug(d);var e=this.controls.audioplayer[0],f=.5,g=e.duration,h=parseFloat(d.audioend);!isNaN(g)&&g>h+f&&(h+=f);var i=parseFloat(d.audiostart);i-f>0&&(i-=f),e.currentTime=i,a(this.controls.audioplayer).off("timeupdate"),a(this.controls.audioplayer).on("timeupdate",function(b){var c=e.currentTime;c>=h&&(a(this).off("timeupdate"),e.pause())}),e.play()},fetchTurnEndWord:function(b){var c=a("#"+this.cd.wordclass+"_"+b),d=c.siblings("."+this.cd.wordclass).last(),e=d.attr("data-wordnumber");return(!e||e<b)&&(e=b),e},fetchTurnStartWord:function(b){var c=a("#"+this.cd.wordclass+"_"+b),d=c.siblings("."+this.cd.wordclass).first(),e=d.attr("data-wordnumber");return(!e||e>b)&&(e=b),e},fetchWordPlayChain:function(b){var c=a("#"+this.cd.wordclass+"_"+b).hasClass(this.cd.badwordclass),d=a("#"+this.cd.wordclass+"_"+b).hasClass(this.cd.aiunmatched);if(c||d)return this.fetchBadWordPlayChain(b);var e=this.options.sessionmatches[""+b].audiostart,f=this.options.sessionmatches[""+b].audioend,g={};return g.startword=b,g.endword=b,g.audiostart=e,g.audioend=f,g},fetchBadWordPlayChain:function(b){for(var c=0,d=0,e=b,f=-1,g=b;g>0;g--){var h=a("#"+this.cd.wordclass+"_"+g).hasClass(this.cd.badwordclass),i=a("#"+this.cd.wordclass+"_"+g).hasClass(this.cd.aiunmatched);if(!h&&!i)break;e=g,i?f=-1:(f=this.options.sessionmatches[""+g].audiostart,c=g)}if(f===-1){f=0;for(var g=e-1;g>0;g--)if(this.options.sessionmatches[""+g]){f=this.options.sessionmatches[""+g].audioend,c=g;break}}for(var j=b,k=-1,l=this.options.totalwordcount,g=b;g<=l;g++){var h=a("#"+this.cd.wordclass+"_"+g).hasClass(this.cd.badwordclass),i=a("#"+this.cd.wordclass+"_"+g).hasClass(this.cd.aiunmatched);if(!h&&!i)break;j=g,i?k=-1:(k=this.options.sessionmatches[""+g].audioend,d=g)}if(k===-1){k=this.options.totalseconds;for(var g=j+1;g<=l;g++)if(this.options.sessionmatches[""+g]){k=this.options.sessionmatches[""+g].audiostart,d=g;break}}var m={};m.startword=e,m.endword=parseInt(j),m.audiostart=f,m.audioend=parseInt(k);var n=this.fetchTurnStartWord(b),o=this.fetchTurnEndWord(b),p=0,q=0,r=0,s=0;return c>0&&c<n&&(p=b-n+1),d>o&&(q=o-b+1),p&&q||(p?(r=.5*p,m.audiostart=m.audioend-r,console.log("startadjust:"+r)):q&&(s=.7*q,m.audioend=m.audiostart+s,console.log("endadjust:"+r))),console.log(m),m},doSpotCheckMode:function(){this.markup_aiunmatchedwords(),a("."+this.cd.badwordclass).addClass(this.cd.spotcheckmode),this.markup_aiunmatchedspaces(),this.currentmode="spotcheck"},markup_aiunmatchedwords:function(){var b=this;if(this.options.sessionmatches){var c=0;a.each(this.options.sessionmatches,function(d,e){var f=d-c-1;if(f>0)for(var g=1;g<f+1;g++){var h=c+g;a("#"+b.cd.wordclass+"_"+h).addClass(b.cd.aiunmatched)}c=parseInt(d)});for(var d=c+1;d<=this.options.endwordnumber;d++)a("#"+b.cd.wordclass+"_"+d).addClass(b.cd.aiunmatched)}},markup_aiunmatchedspaces:function(){var b=this;a("."+this.cd.wordclass+"."+this.cd.aiunmatched).each(function(c){var d=parseInt(a(this).attr("data-wordnumber"));(a("#"+b.cd.wordclass+"_"+(d+1)).hasClass(b.cd.spotcheckmode)||a("#"+b.cd.wordclass+"_"+(d+1)).hasClass(b.cd.aiunmatched))&&a("#"+b.cd.spaceclass+"_"+d).addClass(b.cd.aiunmatched)})},undoSpotCheckMode:function(){a("."+this.cd.badwordclass).removeClass(this.cd.spotcheckmode),a("."+this.cd.spaceclass).removeClass(this.cd.spotcheckmode),a("."+this.cd.wordclass).removeClass(this.cd.aiunmatched),a("."+this.cd.spaceclass).removeClass(this.cd.aiunmatched),a(this.controls.audioplayer).off("timeupdate"),c.remove()},doTranscriptCheckMode:function(){var b=this;if(this.options.sessionmatches){var c=0;a.each(this.options.sessionmatches,function(d,e){var f=d-c-1;if(f>0)for(var g=1;g<f+1;g++){var h=c+g;a("#"+b.cd.wordclass+"_"+h).addClass(b.cd.aiunmatched)}c=parseInt(d)});for(var d=c+1;d<=this.options.endwordnumber;d++)a("#"+b.cd.wordclass+"_"+d).addClass(b.cd.aiunmatched)}a("."+this.cd.aiunmatched).each(function(c){var d=parseInt(a(this).attr("data-wordnumber"));a("#"+b.cd.wordclass+"_"+(d+1)).hasClass(b.cd.aiunmatched)&&a("#"+b.cd.spaceclass+"_"+d).addClass(b.cd.aiunmatched)}),this.currentmode="transcriptcheck"},undoTranscriptCheckMode:function(){a("."+this.cd.wordclass).removeClass(this.cd.aiunmatched),a("."+this.cd.spaceclass).removeClass(this.cd.aiunmatched)},fetchTranscriptChunk:function(b){var c=this.options.transcriptwords.length;if(0===c)return"";for(var d=-1,e=-1,f=b;f>0;f--){var g=a("#"+this.cd.wordclass+"_"+f).hasClass(this.cd.aiunmatched),h=a("#"+this.cd.wordclass+"_"+f).hasClass(this.cd.unreadwordclass);if(!g&&!h){d=this.options.sessionmatches[""+f].tposition+1;var e=f;break}}for(var i=-1,j=-1,f=b;f<=c;f++){var g=a("#"+this.cd.wordclass+"_"+f).hasClass(this.cd.aiunmatched);if(!g){i=this.options.sessionmatches[""+f].tposition-1,j=f;break}}if(d===-1&&(d=1),i===c)i=-1;else if(0===i||i<d)return!1;var k=this.fetchTurnStartWord(b),l=this.fetchTurnEndWord(b),m=0,n=0;if(e<k)var m=b-k+1;if(j>l||j==-1)var n=l-b+1;if(m&&n)return!1;if(m){if(d=i-m,d<1)return!1}else if(n&&(i=d+n,i>+c))return!1;d--;var o=!1;return o=i>0?this.options.transcriptwords.slice(d,i).join(" "):this.options.transcriptwords.slice(d).join(" "),""!==o.trim()&&o},markup_badwords:function(){var b=this;this.processunread(),this.options.reviewmode==this.constants.REVIEWMODE_SHOWERRORS&&a.each(b.options.errorwords,function(c){a("#"+b.cd.wordclass+"_"+b.options.errorwords[c].wordnumber).addClass(b.cd.badwordclass)})},markup_turns:function(){var b=this,c='<span class="'+b.cd.turnclass+'"></span>';a.each(b.options.turns,function(d){for(var e=a("#"+b.cd.wordclass+"_"+b.options.turns[d].start),f=a(c).insertBefore(e),g=b.options.turns[d].start;g<=b.options.turns[d].end;g++)f.append(a("#"+b.cd.wordclass+"_"+g)),f.append(a("#"+b.cd.spaceclass+"_"+g))})},processspace:function(){var b=this,c=a(this).attr("data-wordnumber"),d=a("#"+b.cd.spaceclass+"_"+c);c===b.options.endwordnumber?(b.options.endwordnumber=b.options.totalwordcount,d.removeClass(b.cd.endspaceclass),a("#"+b.cd.spaceclass+"_"+b.options.totalwordcount).addClass(b.cd.endspaceclass)):(a("#"+b.cd.spaceclass+"_"+b.options.endwordnumber).removeClass(b.cd.endspaceclass),b.options.endwordnumber=c,d.addClass(b.cd.endspaceclass)),b.processunread(),b.processscores()},processunread:function(){var b=this;b.controls.eachword.each(function(c){var d=a(this).attr("data-wordnumber"),e=a("#"+b.cd.spaceclass+"_"+d);Number(d)>Number(b.options.endwordnumber)?(a(this).addClass(b.cd.unreadwordclass),e.addClass(b.cd.unreadspaceclass),b.options.enforcemarker&&d in b.options.errorwords&&(delete b.options.errorwords[d],a(this).removeClass(b.cd.badwordclass))):(a(this).removeClass(b.cd.unreadwordclass),e.removeClass(b.cd.unreadspaceclass))})}}});